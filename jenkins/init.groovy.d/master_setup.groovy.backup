import jenkins.model.*
import org.jenkinsci.plugins.workflow.job.WorkflowJob
import org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*
import org.jenkinsci.plugins.plaincredentials.impl.StringCredentialsImpl
import hudson.util.Secret
import hudson.plugins.sonar.SonarGlobalConfiguration
import hudson.plugins.sonar.SonarInstallation

def instance = Jenkins.getInstance()

println "=== INICIALIZACI√ìN COMPLETA DE JENKINS ==="

// Nota: Las credenciales y la configuraci√≥n de SonarQube se manejan en jenkins.yaml (JCasC)
println "‚ÑπÔ∏è Credenciales y SonarQube configurados v√≠a JCasC (jenkins.yaml)"

// FORZAR ACTUALIZACI√ìN DE CREDENCIAL SONARQUBE
println "üîß Forzando actualizaci√≥n de credencial SonarQube..."
def domain = Domain.global()
def store = SystemCredentialsProvider.getInstance().getStore()

// Eliminar credencial existente
def existingCreds = CredentialsProvider.lookupCredentials(
    StringCredentialsImpl.class, instance, null, null
)
def oldCred = existingCreds.find { it.id == 'sonar-token' }
if (oldCred) {
    store.removeCredentials(domain, oldCred)
    println "üóëÔ∏è Credencial anterior eliminada"
}

// Crear credencial con token correcto
def sonarToken = new StringCredentialsImpl(
    CredentialsScope.GLOBAL,
    "sonar-token",
    "Token para SonarQube (Global Analysis)",
    Secret.fromString("squ_d2ac3524ea38222d40e8098a07f1f9a8fcf780b4")
)
store.addCredentials(domain, sonarToken)
println "‚úÖ Credencial sonar-token creada/actualizada correctamente"

// Guardar cambios
instance.save()
println "‚úÖ Configuraci√≥n guardada"

// ============================================================================
// CONFIGURACI√ìN DE PIPELINES PARA TODOS LOS MICROSERVICIOS
// ============================================================================

// 1. PIPELINE: jwtmanual-taller1-micro (Domain Service)
createJavaMavenPipeline(
    instance,
    "jwtmanual-pipeline",
    "https://github.com/Tourment0412/jwtmanual-taller1-micro.git",
    "jwtmanual-taller1-micro",
    "JWT Manual Taller 1 Microservice",
    "21",
    "jdk21",
    "http://jwtmanual-taller1-micro:8080"
)

// 2. PIPELINE: api-gateway-micro
createJavaMavenPipeline(
    instance,
    "api-gateway-pipeline",
    "https://github.com/MiguelA05/api-gateway-micro.git",
    "api-gateway-micro",
    "API Gateway Microservice",
    "21",
    "jdk21",
    null
)

// 3. PIPELINE: gestion-perfil-micro
createJavaMavenPipeline(
    instance,
    "gestion-perfil-pipeline",
    "https://github.com/Tourment0412/gestion-perfil-micro.git",
    "gestion-perfil-micro",
    "Gesti√≥n de Perfil Microservice",
    "21",
    "jdk21",
    null
)

// 4. PIPELINE: notifications-service-micro (Python)
createPythonPipeline(
    instance,
    "notifications-service-pipeline",
    "https://github.com/MiguelA05/notifications-service-micro.git",
    "notifications-service-micro",
    "Notifications Service Microservice"
)

// 5. PIPELINE: orquestador-solicitudes-micro (Node.js/TypeScript)
createNodeJSPipeline(
    instance,
    "orquestador-solicitudes-pipeline",
    "https://github.com/Tourment0412/orquestador-solicitudes-micro.git",
    "orquestador-solicitudes-micro",
    "Orquestador de Solicitudes Microservice"
)

// 6. PIPELINE: health-check-app-micro (Go)
createGoPipeline(
    instance,
    "health-check-app-pipeline",
    "https://github.com/AndresZunigaZ2005/health-check-app-micro.git",
    "health-check-app-micro",
    "Health Check App Microservice"
)

println "=== INICIALIZACI√ìN COMPLETADA ==="

// ============================================================================
// FUNCIONES AUXILIARES PARA CREAR PIPELINES
// ============================================================================

def createJavaMavenPipeline(instance, jobName, repoUrl, projectKey, projectName, javaVersion, jdkTool, baseUrl) {
    println "\nüì¶ Creando pipeline para ${projectName}..."
    
    // Eliminar job existente si existe
    def existingJob = instance.getItem(jobName)
    if (existingJob != null) {
        println "üóëÔ∏è Eliminando job existente ${jobName}..."
        existingJob.delete()
    }
    
    def automationTestsUrl = "https://github.com/MiguelA05/automation-tests.git"
    def hasE2ETests = (baseUrl != null)
    def dollar = '$'
    
    def pipelineScript = """
pipeline {
    agent any

    parameters {
        string(name: 'SERVICE_REPO_URL', defaultValue: '${repoUrl}', description: 'Repo del microservicio')
        string(name: 'SERVICE_BRANCH', defaultValue: 'main', description: 'Rama del microservicio')
        ${hasE2ETests ? """
        string(name: 'AUTOMATION_TESTS_REPO_URL', defaultValue: '${automationTestsUrl}', description: 'Repo de tests de automatizaci√≥n')
        string(name: 'AUTOMATION_TESTS_BRANCH', defaultValue: 'main', description: 'Rama de tests de automatizaci√≥n')
        string(name: 'AUT_TESTS_BASE_URL', defaultValue: '${baseUrl}', description: 'Base URL del servicio bajo prueba')
        """ : ""}
    }

    tools {
        maven 'Maven-3.9'
        jdk '${jdkTool}'
    }

    environment {
        MVN_HOME = tool(name: 'Maven-3.9', type: 'maven')
        JDK_HOME = tool(name: '${jdkTool}', type: 'jdk')
        MVN = "${dollar}{MVN_HOME}/bin/mvn"
        SONAR_HOST_URL = "http://sonarqube:9000"
    }

    stages {
        stage('Checkout repos') {
            steps {
                dir('service') {
                    git branch: params.SERVICE_BRANCH, url: params.SERVICE_REPO_URL
                }
                ${hasE2ETests ? """
                dir('automation-tests') {
                    git branch: params.AUTOMATION_TESTS_BRANCH, url: params.AUTOMATION_TESTS_REPO_URL
                }
                """ : ""}
            }
        }

        stage('Build + Unit tests') {
            steps {
                dir('service') {
                    sh 'ls -la'
                    sh "${dollar}{MVN} -v"
                    sh "${dollar}{MVN} clean verify"
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'service/target/surefire-reports/*.xml'
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'service/target/site/jacoco',
                        reportFiles: 'index.html',
                        reportName: 'Reporte de Cobertura'
                    ])
                }
            }
        }

        stage('Acceptance Tests (Gherkin)') {
            steps {
                dir('service') {
                    script {
                        // Ejecutar tests de aceptaci√≥n con Gherkin/Cucumber
                        // Estos tests requieren servicios corriendo, por lo que pueden fallar en CI
                        try {
                            echo "üß™ Ejecutando tests de aceptaci√≥n Gherkin..."
                            echo "‚ö†Ô∏è Nota: Estos tests requieren servicios corriendo (API Gateway, Domain Service, etc.)"
                            sh "${dollar}{MVN} test -Dtest=CucumberAcceptanceTest || true"
                            echo "‚úÖ Tests de aceptaci√≥n Gherkin ejecutados"
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Tests de aceptaci√≥n Gherkin no pudieron ejecutarse: ${dollar}{e.message}"
                            echo "‚ÑπÔ∏è Esto es esperado si los servicios no est√°n disponibles en el entorno de CI"
                            // No fallar el pipeline - los tests de aceptaci√≥n son opcionales en CI
                        }
                    }
                }
            }
            post {
                always {
                    // Publicar reportes de Cucumber si existen
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'service/target',
                        reportFiles: 'cucumber-report.html',
                        reportName: 'Reporte Cucumber (Gherkin)'
                    ])
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    dir('service') {
                        echo "üîç Iniciando an√°lisis de calidad con SonarQube..."
                        withSonarQubeEnv('SonarQube') {
                            withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
                                sh '''
                                    # Usar sonar.login (compatible con versiones antiguas) o sonar.token
                                    ${dollar}{MVN} sonar:sonar \\
                                        -Dsonar.projectKey=${projectKey} \\
                                        -Dsonar.projectName='${projectName}' \\
                                        -Dsonar.projectVersion=1.0 \\
                                        -Dsonar.login=${dollar}{SONAR_TOKEN} \\
                                        -Dsonar.sources=src/main/java \\
                                        -Dsonar.tests=src/test/java \\
                                        -Dsonar.java.binaries=target/classes \\
                                        -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \\
                                        -Dsonar.junit.reportPaths=target/surefire-reports \\
                                        -Dsonar.java.source=${javaVersion} \\
                                        -Dsonar.java.target=${javaVersion} \\
                                        -Dsonar.sourceEncoding=UTF-8
                                '''
                            }
                        }
                        echo "‚úÖ An√°lisis de SonarQube completado"
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    echo "üö¶ Esperando resultado del Quality Gate..."
                    try {
                        timeout(time: 2, unit: 'MINUTES') {
                            def qg = waitForQualityGate()
                            if (qg.status != 'OK') {
                                echo "‚ö†Ô∏è Quality Gate fall√≥: \${qg.status}"
                                echo "‚ÑπÔ∏è Continuando pipeline a pesar del fallo..."
                            } else {
                                echo "‚úÖ Quality Gate aprobado!"
                            }
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Timeout o error esperando Quality Gate: \${e.message}"
                        echo "‚ÑπÔ∏è El an√°lisis de SonarQube se complet√≥ correctamente"
                        echo "‚ÑπÔ∏è Puedes ver los resultados en: http://sonarqube:9000/dashboard?id=${projectKey}"
                        echo "‚ÑπÔ∏è Continuando pipeline..."
                        currentBuild.result = 'SUCCESS'
                    }
                }
            }
        }

        stage('Allure Report') {
            steps {
                dir('service') {
                    script {
                        def hasAllureResults = fileExists('target/allure-results')
                        if (hasAllureResults) {
                            sh "${dollar}{MVN} -q -e allure:report"
                        } else {
                            echo '‚ö†Ô∏è No hay reportes Allure disponibles - continuando sin reportes'
                        }
                    }
                }
                publishHTML([
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'service/target/site/allure-maven-plugin',
                    reportFiles: 'index.html',
                    reportName: 'Reporte Allure'
                ])
            }
        }
        ${hasE2ETests ? """
        stage('E2E Tests') {
            steps {
                script {
                    withEnv([
                        "AUT_TESTS_BASE_URL=${dollar}{params.AUT_TESTS_BASE_URL}"
                    ]) {
                        dir('automation-tests') {
                            sh "${dollar}{MVN} clean test -Dtest=CucumberTest -Dmaven.test.failure.ignore=true"
                            sh "${dollar}{MVN} allure:report"
                            
                            // Verificar que el reporte se gener√≥ correctamente
                            def reportExists = fileExists('target/site/allure-maven-plugin/index.html')
                            if (!reportExists) {
                                error('‚ùå ERROR: Reporte Allure no se gener√≥ correctamente')
                            }
                            echo "‚úÖ Reporte Allure generado exitosamente"
                        }
                    }
                }
                junit allowEmptyResults: true, testResults: 'automation-tests/target/surefire-reports/*.xml'
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'automation-tests/target/site/allure-maven-plugin',
                    reportFiles: 'index.html',
                    reportName: 'Reporte Allure (E2E)'
                ])
            }
        }
        """ : ""}
    }

    post {
        always {
            echo "üìä Pipeline completado para ${projectName}"
        }
        success {
            echo "‚úÖ Pipeline ejecutado exitosamente"
        }
        failure {
            echo "‚ùå Pipeline fall√≥"
        }
    }
}
"""
    
    def flowDefinition = new CpsFlowDefinition(pipelineScript, true)
    def newJob = instance.createProject(WorkflowJob.class, jobName)
    newJob.setDefinition(flowDefinition)
    newJob.setDescription("Pipeline CI/CD para ${projectName}: build, test, SonarQube analysis${hasE2ETests ? ', E2E tests' : ''}")
    newJob.save()
    
    println "‚úÖ Pipeline ${jobName} creado exitosamente"
}

def createPythonPipeline(instance, jobName, repoUrl, projectKey, projectName) {
    println "\nüêç Creando pipeline Python para ${projectName}..."
    
    def existingJob = instance.getItem(jobName)
    if (existingJob != null) {
        println "üóëÔ∏è Eliminando job existente ${jobName}..."
        existingJob.delete()
    }
    
    def dollar = '$'
    def pipelineScript = """
pipeline {
    agent any

    parameters {
        string(name: 'SERVICE_REPO_URL', defaultValue: '${repoUrl}', description: 'Repo del microservicio')
        string(name: 'SERVICE_BRANCH', defaultValue: 'main', description: 'Rama del microservicio')
    }

    environment {
        PYTHON_VERSION = '3.11'
        SONAR_SCANNER_VERSION = '5.0.1.3006'
    }

    stages {
        stage('Checkout') {
            steps {
                dir('service') {
                    git branch: params.SERVICE_BRANCH, url: params.SERVICE_REPO_URL
                }
            }
        }

        stage('Setup Python Environment') {
            steps {
                dir('service') {
                    sh '''
                        python3 --version
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install --upgrade pip
                        
                        # Verificar que requirements.txt existe
                        if [ ! -f requirements.txt ]; then
                            echo "‚ö†Ô∏è requirements.txt no encontrado"
                            touch requirements.txt
                        fi
                        
                        pip install -r requirements.txt
                    '''
                }
            }
        }

        stage('Lint') {
            steps {
                dir('service') {
                    sh '''
                        . venv/bin/activate
                        pip install flake8 pylint
                        
                        echo "üîç Ejecutando flake8..."
                        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exit-zero
                        
                        echo "üîç Ejecutando pylint..."
                        if [ -d "app" ]; then
                            pylint app/ --exit-zero || true
                        else
                            echo "‚ö†Ô∏è Directorio app/ no encontrado, omitiendo pylint"
                        fi
                    '''
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('service') {
                    sh '''
                        . venv/bin/activate
                        pip install pytest pytest-cov
                        
                        if [ -d "tests" ]; then
                            # Excluir tests de aceptaci√≥n de la ejecuci√≥n normal
                            pytest tests/ -v --cov=app --cov-report=html --cov-report=xml --junitxml=test-results.xml --ignore=tests/acceptance || true
                        else
                            echo "‚ö†Ô∏è Directorio tests/ no encontrado"
                            mkdir -p htmlcov
                            echo "<html><body>No tests found</body></html>" > htmlcov/index.html
                        fi
                    '''
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'service/test-results.xml'
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'service/htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Reporte de Cobertura (Python)'
                    ])
                }
            }
        }

        stage('Acceptance Tests (Gherkin)') {
            steps {
                dir('service') {
                    sh '''
                        . venv/bin/activate
                        # Ejecutar tests de aceptaci√≥n con pytest-bdd
                        if [ -d "tests/acceptance" ] || [ -d "features" ]; then
                            pytest tests/acceptance/ -v || pytest features/ -v || true
                            echo "‚úÖ Tests de aceptaci√≥n Gherkin ejecutados"
                        else
                            echo "‚ö†Ô∏è Tests de aceptaci√≥n Gherkin no encontrados"
                        fi
                    '''
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    dir('service') {
                        withSonarQubeEnv('SonarQube') {
                            withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
                                sh '''
                                    # Usar sonar-scanner del sistema o descargarlo
                                    if ! command -v sonar-scanner &> /dev/null; then
                                        echo "üì• Descargando SonarScanner..."
                                        wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${dollar}{SONAR_SCANNER_VERSION}-linux.zip
                                        unzip -o -q sonar-scanner-cli-${dollar}{SONAR_SCANNER_VERSION}-linux.zip
                                        export PATH=${dollar}{PWD}/sonar-scanner-${dollar}{SONAR_SCANNER_VERSION}-linux/bin:${dollar}{PATH}
                                    fi
                                    
                                    sonar-scanner \\
                                        -Dsonar.projectKey=${projectKey} \\
                                        -Dsonar.projectName='${projectName}' \\
                                        -Dsonar.login=${dollar}{SONAR_TOKEN} \\
                                        -Dsonar.sources=app \\
                                        -Dsonar.tests=tests \\
                                        -Dsonar.python.coverage.reportPaths=coverage.xml \\
                                        -Dsonar.python.version=3.11 \\
                                        -Dsonar.sourceEncoding=UTF-8
                                '''
                            }
                        }
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    echo "üö¶ Esperando resultado del Quality Gate..."
                    timeout(time: 5, unit: 'MINUTES') {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            echo "‚ö†Ô∏è Quality Gate fall√≥: {qg.status}"
                            echo "‚ÑπÔ∏è Continuando pipeline a pesar del fallo..."
                        } else {
                            echo "‚úÖ Quality Gate aprobado!"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "üìä Pipeline completado para ${projectName}"
        }
        success {
            echo "‚úÖ Pipeline ejecutado exitosamente"
        }
        failure {
            echo "‚ùå Pipeline fall√≥"
        }
    }
}
"""
    
    def flowDefinition = new CpsFlowDefinition(pipelineScript, true)
    def newJob = instance.createProject(WorkflowJob.class, jobName)
    newJob.setDefinition(flowDefinition)
    newJob.setDescription("Pipeline CI/CD para ${projectName} (Python): build, test, lint, SonarQube analysis")
    newJob.save()
    
    println "‚úÖ Pipeline ${jobName} creado exitosamente"
}

def createNodeJSPipeline(instance, jobName, repoUrl, projectKey, projectName) {
    println "\nüì¶ Creando pipeline Node.js/TypeScript para ${projectName}..."
    
    def existingJob = instance.getItem(jobName)
    if (existingJob != null) {
        println "üóëÔ∏è Eliminando job existente ${jobName}..."
        existingJob.delete()
    }
    
    def dollar = '$'
    def pipelineScript = """
pipeline {
    agent any

    parameters {
        string(name: 'SERVICE_REPO_URL', defaultValue: '${repoUrl}', description: 'Repo del microservicio')
        string(name: 'SERVICE_BRANCH', defaultValue: 'main', description: 'Rama del microservicio')
    }

    environment {
        NODE_VERSION = '20'
        SONAR_SCANNER_VERSION = '5.0.1.3006'
    }

    stages {
        stage('Checkout') {
            steps {
                dir('service') {
                    git branch: params.SERVICE_BRANCH, url: params.SERVICE_REPO_URL
                }
            }
        }

        stage('Setup Node.js') {
            steps {
                dir('service') {
                    sh '''
                        node --version
                        npm --version
                        
                        # Usar npm ci si existe package-lock.json, sino npm install
                        if [ -f package-lock.json ]; then
                            npm ci
                        else
                            npm install
                        fi
                    '''
                }
            }
        }

        stage('Lint') {
            steps {
                dir('service') {
                    sh '''
                        # Verificar si existe script de lint
                        if npm run | grep -q "lint"; then
                            npm run lint || echo "‚ö†Ô∏è Lint fall√≥ pero continuando..."
                        else
                            echo "‚ö†Ô∏è Script lint no configurado en package.json"
                        fi
                    '''
                }
            }
        }

        stage('Build') {
            steps {
                dir('service') {
                    sh '''
                        # Verificar si existe script de build
                        if npm run | grep -q "build"; then
                            npm run build
                        else
                            echo "‚ö†Ô∏è Script build no configurado, omitiendo..."
                        fi
                    '''
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('service') {
                    sh '''
                        # Verificar si existe script de test
                        if npm run | grep -q "test"; then
                            npm test -- --coverage --watchAll=false --ci || true
                        else
                            echo "‚ö†Ô∏è Script test no configurado"
                            mkdir -p coverage
                            echo "<html><body>No tests configured</body></html>" > coverage/index.html
                        fi
                    '''
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'service/coverage/lcov-report',
                        reportFiles: 'index.html',
                        reportName: 'Reporte de Cobertura (Jest)'
                    ])
                }
            }
        }

        stage('Acceptance Tests (Gherkin)') {
            steps {
                dir('service') {
                    sh '''
                        # Ejecutar tests de aceptaci√≥n con Cucumber.js
                        if [ -d "features" ] && [ -f "package.json" ]; then
                            npx @cucumber/cucumber --require-module ts-node/register --require 'features/step_definitions/*.ts' || npx cucumber-js || true
                            echo "‚úÖ Tests de aceptaci√≥n Gherkin ejecutados"
                        else
                            echo "‚ö†Ô∏è Tests de aceptaci√≥n Gherkin no encontrados"
                        fi
                    '''
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'service/reports',
                        reportFiles: 'cucumber-report.html',
                        reportName: 'Reporte Cucumber (Gherkin)'
                    ])
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    dir('service') {
                        withSonarQubeEnv('SonarQube') {
                            withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
                                sh '''
                                    # Usar sonar-scanner del sistema o descargarlo
                                    if ! command -v sonar-scanner &> /dev/null; then
                                        echo "üì• Descargando SonarScanner..."
                                        wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${dollar}{SONAR_SCANNER_VERSION}-linux.zip
                                        unzip -o -q sonar-scanner-cli-${dollar}{SONAR_SCANNER_VERSION}-linux.zip
                                        export PATH=${dollar}{PWD}/sonar-scanner-${dollar}{SONAR_SCANNER_VERSION}-linux/bin:${dollar}{PATH}
                                    fi
                                    
                                    sonar-scanner \\
                                        -Dsonar.projectKey=${projectKey} \\
                                        -Dsonar.projectName='${projectName}' \\
                                        -Dsonar.login=${dollar}{SONAR_TOKEN} \\
                                        -Dsonar.sources=src \\
                                        -Dsonar.tests=src \\
                                        -Dsonar.test.inclusions=**/*.test.ts,**/*.test.js,**/*.spec.ts,**/*.spec.js \\
                                        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \\
                                        -Dsonar.sourceEncoding=UTF-8
                                '''
                            }
                        }
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    echo "üö¶ Esperando resultado del Quality Gate..."
                    timeout(time: 5, unit: 'MINUTES') {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            echo "‚ö†Ô∏è Quality Gate fall√≥: {qg.status}"
                            echo "‚ÑπÔ∏è Continuando pipeline a pesar del fallo..."
                        } else {
                            echo "‚úÖ Quality Gate aprobado!"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "üìä Pipeline completado para ${projectName}"
        }
        success {
            echo "‚úÖ Pipeline ejecutado exitosamente"
        }
        failure {
            echo "‚ùå Pipeline fall√≥"
        }
    }
}
"""
    
    def flowDefinition = new CpsFlowDefinition(pipelineScript, true)
    def newJob = instance.createProject(WorkflowJob.class, jobName)
    newJob.setDefinition(flowDefinition)
    newJob.setDescription("Pipeline CI/CD para ${projectName} (Node.js/TypeScript): build, test, lint, SonarQube analysis")
    newJob.save()
    
    println "‚úÖ Pipeline ${jobName} creado exitosamente"
}

def createGoPipeline(instance, jobName, repoUrl, projectKey, projectName) {
    println "\nüêπ Creando pipeline Go para ${projectName}..."
    
    def existingJob = instance.getItem(jobName)
    if (existingJob != null) {
        println "üóëÔ∏è Eliminando job existente ${jobName}..."
        existingJob.delete()
    }
    
    def dollar = '$'
    def pipelineScript = """
pipeline {
    agent any

    parameters {
        string(name: 'SERVICE_REPO_URL', defaultValue: '${repoUrl}', description: 'Repo del microservicio')
        string(name: 'SERVICE_BRANCH', defaultValue: 'main', description: 'Rama del microservicio')
    }

    environment {
        GO_VERSION = '1.22'
        SONAR_SCANNER_VERSION = '5.0.1.3006'
        GOPATH = "\${WORKSPACE}/go"
        PATH = "\${GOPATH}/bin:/usr/local/go/bin:\${PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                dir('service') {
                    git branch: params.SERVICE_BRANCH, url: params.SERVICE_REPO_URL
                }
            }
        }

        stage('Setup Go') {
            steps {
                dir('service') {
                    sh '''
                        go version
                        go mod download
                        go mod verify
                    '''
                }
            }
        }

        stage('Lint') {
            steps {
                dir('service') {
                    sh '''
                        # Instalar golangci-lint si no est√° disponible
                        if ! command -v golangci-lint &> /dev/null; then
                            echo "üì• Instalando golangci-lint..."
                            go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
                        fi
                        
                        # Ejecutar linter
                        golangci-lint run ./... || echo "‚ö†Ô∏è Lint encontr√≥ problemas pero continuando..."
                    '''
                }
            }
        }

        stage('Build') {
            steps {
                dir('service') {
                    sh '''
                        go build -v ./...
                    '''
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('service') {
                    sh '''
                        # Ejecutar tests con cobertura (excluyendo tests de aceptaci√≥n)
                        # Excluir directorio features que contiene tests de aceptaci√≥n con godog
                        go test -v -coverprofile=coverage.out -covermode=atomic \$(go list ./... | grep -v '/features') || true
                        
                        # Generar reporte HTML de cobertura
                        if [ -f coverage.out ]; then
                            go tool cover -html=coverage.out -o coverage.html
                        fi
                        
                        # Generar reporte XML para Jenkins
                        if ! command -v gocover-cobertura &> /dev/null; then
                            go install github.com/boumenot/gocover-cobertura@latest
                        fi
                        if [ -f coverage.out ]; then
                            gocover-cobertura < coverage.out > coverage.xml || true
                        fi
                    '''
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'service',
                        reportFiles: 'coverage.html',
                        reportName: 'Reporte de Cobertura (Go)'
                    ])
                }
            }
        }

        stage('Acceptance Tests (Gherkin)') {
            steps {
                dir('service') {
                    sh '''
                        # Ejecutar tests de aceptaci√≥n con godog
                        if [ -d "features" ]; then
                            go test ./features/... -v || true
                            echo "‚úÖ Tests de aceptaci√≥n Gherkin ejecutados"
                        else
                            echo "‚ö†Ô∏è Tests de aceptaci√≥n Gherkin no encontrados"
                        fi
                    '''
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    dir('service') {
                        withSonarQubeEnv('SonarQube') {
                            withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
                                sh '''
                                    # Usar sonar-scanner del sistema o descargarlo
                                    if ! command -v sonar-scanner &> /dev/null; then
                                        echo "üì• Descargando SonarScanner..."
                                        wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${dollar}{SONAR_SCANNER_VERSION}-linux.zip
                                        unzip -o -q sonar-scanner-cli-${dollar}{SONAR_SCANNER_VERSION}-linux.zip
                                        export PATH=${dollar}{PWD}/sonar-scanner-${dollar}{SONAR_SCANNER_VERSION}-linux/bin:${dollar}{PATH}
                                    fi
                                    
                                    sonar-scanner \\
                                        -Dsonar.projectKey=${projectKey} \\
                                        -Dsonar.projectName='${projectName}' \\
                                        -Dsonar.login=${dollar}{SONAR_TOKEN} \\
                                        -Dsonar.sources=. \\
                                        -Dsonar.tests=. \\
                                        -Dsonar.test.inclusions=**/*_test.go \\
                                        -Dsonar.exclusions=**/*_test.go,**/vendor/** \\
                                        -Dsonar.go.coverage.reportPaths=coverage.out \\
                                        -Dsonar.sourceEncoding=UTF-8
                                '''
                            }
                        }
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    echo "üö¶ Esperando resultado del Quality Gate..."
                    timeout(time: 5, unit: 'MINUTES') {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            echo "‚ö†Ô∏è Quality Gate fall√≥: {qg.status}"
                            echo "‚ÑπÔ∏è Continuando pipeline a pesar del fallo..."
                        } else {
                            echo "‚úÖ Quality Gate aprobado!"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "üìä Pipeline completado para ${projectName}"
        }
        success {
            echo "‚úÖ Pipeline ejecutado exitosamente"
        }
        failure {
            echo "‚ùå Pipeline fall√≥"
        }
    }
}
"""
    
    def flowDefinition = new CpsFlowDefinition(pipelineScript, true)
    def newJob = instance.createProject(WorkflowJob.class, jobName)
    newJob.setDefinition(flowDefinition)
    newJob.setDescription("Pipeline CI/CD para ${projectName} (Go): build, test, lint, SonarQube analysis")
    newJob.save()
    
    println "‚úÖ Pipeline ${jobName} creado exitosamente"
}